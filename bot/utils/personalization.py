"""Персонализированные тексты и хуки для пользователя."""

from datetime import datetime
from typing import Optional

# ═══════════════════════════════════════════════════════════
# ХУКИ — персональные "зацепки" для каждого числа
# ═══════════════════════════════════════════════════════════

LIFE_PATH_HOOKS = {
    1: {
        "hook": "Ты родился(а) лидером, но иногда забываешь, что не обязан(а) тащить всё сам(а)",
        "childhood": "В детстве, скорее всего, ты был(а) капитаном во дворе — или мечтал(а) им стать",
        "trap": "Брать на себя слишком много и ворчать, что никто не помогает",
        "action": "Делегируй одну задачу сегодня. Даже если сделают хуже — мир не рухнет",
    },
    2: {
        "hook": "Ты чувствуешь людей лучше, чем они сами. Иногда это выматывает",
        "childhood": "Ты был(а) тем, кто мирил друзей после ссор. Дипломат с пелёнок",
        "trap": "Угождать всем и терять себя в чужих ожиданиях",
        "action": "Скажи 'нет' одной просьбе сегодня. Без объяснений",
    },
    3: {
        "hook": "Ты заражаешь других энергией. Но когда тебе плохо — маска спадает резко",
        "childhood": "Ты был(а) душой компании и классным клоуном. Или мечтал(а) быть",
        "trap": "Разбрасываться энергией на всё подряд, не доводить до конца",
        "action": "Выбери ОДНО творческое дело этой недели. Закрой всё остальное",
    },
    4: {
        "hook": "Ты строишь фундамент под чужие мечты. Пора под свои",
        "childhood": "Ты собирал(а) конструктор по инструкции, пока другие лепили кашу",
        "trap": "Застревать в рутине и называть это 'стабильностью'",
        "action": "Нарушь одно правило сегодня. Мелкое, но своё",
    },
    5: {
        "hook": "Ты — ветер в человеческом обличье. Стоишь на месте — умираешь",
        "childhood": "Ты менял(а) хобби каждый месяц. Или сбегал(а) из дома 'на разведку'",
        "trap": "Бросать начатое на полпути, потому что 'стало скучно'",
        "action": "Допиши/доделай то, что бросил(а) 3 месяца назад. Для баланса",
    },
    6: {
        "hook": "Ты лечишь других, но кто лечит тебя?",
        "childhood": "Ты утешал(а) плачущих одноклассников. Был(а) 'мамой' компании",
        "trap": "Спасать тех, кто не просил. И страдать, когда не благодарят",
        "action": "Позвони/напиши человеку, который заботится о тебе. Просто так",
    },
    7: {
        "hook": "Ты не веришь на слово — проверяешь сам(а). Это суперсила и проклятие",
        "childhood": "Ты разбирал(а) игрушки, часы, компьютер — чтобы понять как работает",
        "trap": "Застревать в анализе и никогда не решаться",
        "action": "Задай себе вопрос, на который не знаешь ответ. Запиши. Ответ придёт через 2-3 дня",
    },
    8: {
        "hook": "Ты видишь деньги как очки в игре. Но иногда забываешь — игра должна приносить удовольствие",
        "childhood": "Ты продавал(а) что-то одноклассникам или считал(а) карманные деньги соседей",
        "trap": "Мерить всё деньгами и успехом, забывать зачем это всё",
        "action": "Сделай что-то бесплатно сегодня. Без расчёта на отдачу",
    },
    9: {
        "hook": "Ты здесь, чтобы завершить что-то важное. Но что именно — выбираешь ты",
        "childhood": "Ты чувствовал(а) себя 'взрослее' сверстников. Или 'не от мира сего'",
        "trap": "Жить прошлым или мечтами, игнорировать настоящее",
        "action": "Отпусти одну обиду сегодня. Не для них — для себя",
    },
    11: {
        "hook": "Ты чувствуешь то, что другие не видят. Это дар и нагрузка",
        "childhood": "У тебя были 'видения' или сильная интуиция, которую не понимали взрослые",
        "trap": "Бояться своей силы и прятаться в 'нормальность'",
        "action": "Запиши сон или мысль, которая пришла 'из ниоткуда'. Проверь через неделю",
    },
    22: {
        "hook": "Ты строишь мосты между небом и землёй. Тяжёлая работа",
        "childhood": "Ты мечтал(а) о масштабных проектах — города, мосты, спасение мира",
        "trap": "Думать, что должен(на) всё сделать сам(а). Или не делать ничего из-за масштаба",
        "action": "Разбери большую цель на 3 маленьких шага. Сделай первый сегодня",
    },
    33: {
        "hook": "Ты несёшь свет другим. Но фонарь тоже нуждается в батарейках",
        "childhood": "Ты утешал(а) всех — животных, кукол, друзей. Был(а) 'маленьким ангелом'",
        "trap": "Жертвовать собой и называть это 'любовью'",
        "action": "Попроси о помощи сегодня. Даже в мелочи. Практикуй получать",
    },
}

# ═══════════════════════════════════════════════════════════
# ШАБЛОНЫ ОТВЕТОВ
# ═══════════════════════════════════════════════════════════

NUMEROLOGY_LIFE_PATH_TEMPLATE = """🔮 {name}, твоё число жизненного пути — {number}

{hook}

{childhood}.

⚠️ Твоя ловушка:
{trap}

💡 Сейчас важно:
{current_advice}

🎯 Действие сегодня:
{action}

📊 Осталось запросов сегодня: {remaining}
"""

NUMEROLOGY_FULL_REPORT_TEMPLATE = """🔮 {name}, твой нумерологический профиль

<b>Число жизненного пути ({life_path}):</b>
{life_path_meaning}

<b>Число души ({soul}):</b>
{soul_meaning}

<b>Число личности ({personality}):</b>
{personality_meaning}

<b>Число судьбы ({destiny}):</b>
{destiny_meaning}

<b>Персональный год ({personal_year}):</b>
{personal_year_meaning}

💡 Ключевой инсайт:
{key_insight}

🎯 Фокус этого года:
{year_focus}
"""

# ═══════════════════════════════════════════════════════════
# ТАРО — ПОВЕСТВОВАТЕЛЬНЫЕ ШАБЛОНЫ
# ═══════════════════════════════════════════════════════════

TAROT_THREE_CARDS_TEMPLATE = """🃏 {name}, твой расклад говорит о переломе

<b>Прошлое — {past_card}{past_reversed}:</b>
{past_story}

<b>Настоящее — {present_card}{present_reversed}:</b>
{present_story}

<b>Будущее — {future_card}{future_reversed}:</b>
{future_story}

⚡ Ключевой вопрос:
{key_question}

💡 <i>Нажми «AI-трактовка» для персональной интерпретации</i>
"""

TAROT_DAILY_TEMPLATE = """🌅 Доброе {time_of_day}, {name}!

<b>Твоя карта дня — {card_name}{reversed}:</b>

{card_story}

💡 Совет дня:
{advice}

🤔 Вопрос для размышления:
{reflection_question}

📅 Персональный год {personal_year}:
{year_hint}
"""

TAROT_DECISION_TEMPLATE = """⚡ {name}, расклад для твоего вопроса

<b>Вопрос:</b> {question}

<b>Вариант А — {left_card}{left_reversed}:</b>
{left_story}

<b>Вариант Б — {right_card}{right_reversed}:</b>
{right_story}

<b>Суть ситуации — {center_card}{center_reversed}:</b>
{center_story}

🎯 Рекомендация:
{recommendation}
"""

# ═══════════════════════════════════════════════════════════
# ПРИВЕТСТВИЯ ПО ВРЕМЕНИ СУТОК
# ═══════════════════════════════════════════════════════════

def get_time_greeting(hour: int) -> str:
    """Возвращает приветствие по времени суток."""
    if 5 <= hour < 12:
        return "утро"
    elif 12 <= hour < 17:
        return "день"
    elif 17 <= hour < 22:
        return "вечер"
    else:
        return "ночь"

def get_greeting_by_time(hour: int) -> str:
    """Возвращает полное приветствие."""
    time_of_day = get_time_greeting(hour)
    greetings = {
        "утро": "🌅 Утро — время для установки настроя",
        "день": "☀️ День в разгаре — проверь, куда уходит энергия",
        "вечер": "🌆 Вечер — время подвести итоги и отпустить",
        "ночь": "🌙 Ночь — время, когда правда говорит громче",
    }
    return greetings.get(time_of_day, "Привет")

# ═══════════════════════════════════════════════════════════
# ПЕРСОНАЛИЗАЦИЯ ПО ИСТОРИИ
# ═══════════════════════════════════════════════════════════

def get_repeat_card_message(card_name: str, count: int) -> Optional[str]:
    """Генерирует сообщение о повторяющейся карте."""
    if count < 2:
        return None
    if count == 2:
        return f"🔄 {card_name} выпадает второй раз — вселенная стучит в дверь"
    if count == 3:
        return f"🚨 {card_name} — ТРЕТИЙ РАЗ! Это уже не совпадение, это паттерн"
    return f"💥 {card_name} — {count} раз! Ты точно обращаешь внимание?"

def get_personalized_numerology_intro(name: str, birth_date: str) -> str:
    """Генерирует персональное вступление для нумерологии."""
    from datetime import datetime
    date = datetime.strptime(birth_date, "%Y-%m-%d")
    age = (datetime.now() - date).days // 365
    
    if age < 25:
        return f"{name}, ты на этапе становления. Числа покажут, какой фундамент заложить"
    elif age < 40:
        return f"{name}, сейчас ты строишь главное. Числа подскажут, что усилить"
    else:
        return f"{name}, пришло время свериться — идёшь ли туда, куда хотел(а)"

# ═══════════════════════════════════════════════════════════
# СТОРИ ДЛЯ КАРТ ТАРО (примеры)
# ═══════════════════════════════════════════════════════════

CARD_STORIES = {
    "Дурак": {
        "upright": "Новое начало зовёт. Ты стоишь на краю пропасти — но это не пропасть, это порог. Шагни",
        "reversed": "Ты прыгаешь, не глядя. Или, наоборот, боишься прыгнуть уже слишком долго. Проверь: страх или интуиция?",
    },
    "Маг": {
        "upright": "У тебя есть все инструменты. Вопрос — ты их видишь? Смотри внимательнее вокруг",
        "reversed": "Ты либо недооцениваешь свои силы, либо пытаешься манипулировать. Проверь намерения",
    },
    "Жрица": {
        "upright": "Ответы внутри. Но для этого нужно заткнуть внешний шум на 5 минут. Готов(а)?",
        "reversed": "Ты либо игнорируешь интуицию, либо путаешь её с тревогой. Научись различать",
    },
    "Императрица": {
        "upright": "Плодородие — не только про детей. Про проекты, идеи, рост. Что ты вынашиваешь?",
        "reversed": "Перекорм или голод. Либо слишком много берёшь на себя, либо не даёшь себе расти",
    },
    "Император": {
        "upright": "Время структуры и границ. Ты либо строишь, либо разрушаешь — выбирай осознанно",
        "reversed": "Тирания или хаос. Либо ты контролируешь слишком много, либо ничего не контролируешь",
    },
    # ... можно добавить все 78 карт
}

def get_card_story(card_name: str, reversed: bool = False) -> str:
    """Возвращает историю для карты."""
    story = CARD_STORIES.get(card_name, {})
    if reversed:
        return story.get("reversed", "Карта перевернута — энергия заблокирована или извращена")
    return story.get("upright", "Классическое значение карты")
